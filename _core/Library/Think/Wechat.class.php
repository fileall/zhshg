<?php namespace Think; header("Content-type: text/html; charset=utf-8");   /** * 微信授权相关接口 *  * @link http://www.phpddt.com */
class Wechat {		    //高级功能-》开发者模式-》获取    private $app_id = 'wx049fe5b5c6f2037a';    private $app_secret = '040117273df9e91ec66b3e3d011e3e2e';    	//保存在有效期内的access_token	private $lasttime = 0;    private $access_token = '';  		/*v	 * 获取基础access_token	 */	public function wx_api(){		$this->lasttime = S('wx_lasttime') ? S('wx_lasttime') : 0;		$this->access_token = S('wx_access_token'); 				if(time() > ($this->lasttime + 7200)){			$url="https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=".$this->app_id."&secret=".$this->app_secret;			$res = $this->http($url);			$res = json_decode($res[1],TRUE);					 	S('wx_lasttime',time(),$res['expires_in']);         	S('wx_access_token',$res['access_token'],$res['expires_in']);			 		 	$this->lasttime = S('wx_lasttime');    		$this->access_token = S('wx_access_token');        		}				return $this->access_token;	}      
    /**        * 获取微信授权链接     *      * @param string $redirect_uri 跳转地址     * @param mixed $state 参数     */
    public function get_authorize_url($redirect_uri = '', $state = '')    {        $redirect_uri = urlencode($redirect_uri);        return "https://open.weixin.qq.com/connect/oauth2/authorize?appid={$this->app_id}&redirect_uri={$redirect_uri}&response_type=code&scope=snsapi_base&state={$state}#wechat_redirect";    }    	  public function get_authorize_url1($redirect_uri = '', $state = '')    {        $redirect_uri = urlencode($redirect_uri);        return "https://open.weixin.qq.com/connect/oauth2/authorize?appid={$this->app_id}&redirect_uri={$redirect_uri}&response_type=code&scope=snsapi_userinfo&state={$state}#wechat_redirect";    }
    /**     * 获取授权token     *      * @param string $code 通过get_authorize_url获取到的code     */    public function get_access_token($app_id = '', $app_secret = '', $code = '')    {        $token_url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid={$this->app_id}&secret={$this->app_secret}&code={$code}&grant_type=authorization_code";//		dump($token_url);exit;        $token_data = $this->http($token_url);        if($token_data[0] == 200)        {            return json_decode($token_data[1], TRUE);        }        return FALSE;    }
    
    /**     * 获取授权后的微信用户信息     *      * @param string $access_token     * @param string $open_id     */
    public function get_user_info($access_token = '', $open_id = ''){        if($access_token && $open_id){            $info_url = "https://api.weixin.qq.com/sns/userinfo?access_token={$access_token}&openid={$open_id}&lang=zh_CN";            $info_data = $this->http($info_url);			//return $info_data;exit;            if($info_data[0] == 200)            {                return json_decode($info_data[1], TRUE);            }        }else{        	return FALSE;        }            }
	/**	 * 发关模板消息	 * @param array $data	 */	public function send_message($data){		$url="https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=".$this->access_token;		$res = $this->http_request($url,$data);		return json_decode($res,true);    	}	 	 
    public function http($url)    {        $return = file_get_contents($url);  	    $count = count(json_decode($return, TRUE));	    if($count >= 5){	   	 	return array(200,$return);		    }else{   	   		return array(0,$return);	    }    }
    protected function http_request($url,$data = null){    	$ch = curl_init();		curl_setopt($ch, CURLOPT_URL, $url);
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
		curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);
		if(!empty($data)){			curl_setopt($ch, CURLOPT_POST, 1);
			curl_setopt($ch, CURLOPT_POSTFIELDS, $data);		}		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);		$output = curl_exec($ch);		curl_close($ch);		return $output;    }
}