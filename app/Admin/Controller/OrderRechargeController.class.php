<?phpnamespace Admin\Controller;/** * 会员充值&&支付 * Class AccountController * @package Admin\Controller */class OrderRechargeController extends AdminCoreController{    public function _initialize()    {        parent::_initialize();        $this->_mod=D('OrderRecharge');        $this->set_mod('OrderRecharge');        $this->_member=D('Member');    }    public function index() {        $map = $this->_search();        $mod = $this->_mod;        !empty($mod) && $this->_list($mod, $map);        $this->display();    }    public function _search()    {        $map['type']=2;//状态 1为支付 2为充值',        ($time_start = I('time_start')) && $map['add_time'][]   = ['egt',strtotime($time_start)];        ($time_end = I('time_end'))     && $map['add_time'][]   = ['elt',strtotime($time_end) + 86399];        ($status = I('status','','trim')) && $map['status'] = $status;        ($status==1)&&$map['status']=['in','1,3'];        if( $keyword = I('keyword','', 'trim') ){//真实姓名/电话            $map['_string'] = " member_id in ( select id from jrkj_member where (nickname like '%".$keyword."%' OR mobile like '%".$keyword."%' OR id like '%".$keyword."%' ))";        }        $zftype = I('zftype','','trim');        ('' !== $zftype) && $map['zftype'] = $zftype = (int)$zftype;        $this->assign('search',[            'time_start'    => $time_start,            'time_end'      => $time_end,            'status'        => $status,            'zftype'        => $zftype,            'keyword'       => $keyword,        ]);        return $map;    }            public function _after_list($list) {        if (!empty($list)){            $uids=array_unique(array_column($list,'uid'));            $uids&& $member=$this->_member->where(['id'=>['in',$uids]])->getField('id,nickname,mobile');        }   		$this->assign('member',$member);        return $list;    }    //元宝充值记录    public function export()    {        ob_end_clean();        $map = $this->_search();        $map['member_id']=['not in',[843,1,2,3,4,306,321,325]];        $list = $this->_mod->where($map)->select();        if($list){            $member_ids=array_unique(array_column($list,'member_id'));            $member_ids&&$member=M('member')->where(['id'=>['in',$member_ids]])->getField('id,realname,mobile,nickname');        }        $data = array();        foreach ($list as $k => $v) {            $data[$k]['nickname']= $member[$v['member_id']]['nickname']; //会员名            $data[$k]['realname']= $member[$v['member_id']]['realname']; //会员名            $data[$k]['mobile'] =  $member[$v['member_id']]['mobile'];            $data[$k]['memos']= $v['memos']; //备注            $data[$k]['totalprices']= $v['totalprices']; //开户名            $data[$k]['add_time'] = date('Y-m-d',$v['add_time']); //时间        }        $headArr = array();        $headArr[] = '昵称';        $headArr[] = '会员名';        $headArr[] = '会员电话';        $headArr[] = '备注';        $headArr[] = '金额';        $headArr[] = '时间';        $filename="会员元宝充值记录";        getExceltjab($filename, $headArr, $data);    }}