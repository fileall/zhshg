<?phpnamespace Mobile\Org;class WeiXinAbout{    private $appId;    private $appSecret;    //构造函数，获取Access Token    public function __construct($appid = NULL, $appsecret = NULL)    {        //消息推送获取/第三方登录获取openid：        //$appid = 'wxad4fc1ee40754ebf';        //$appsecret = '834d3d5bc0b5d0dfba43f2f01275ff8e';        //        //支付调微信接口时获取openid：        //$appid = 'wx5c1299e0d98a447e';        //$appsecret = 'a5e57e74278b59658b0efcb0b5776a8d';        #自己封装//      $this->appid = $appid;//appid//      $this->appsecret = $appsecret;//开发者密码        #jssdk        $this->appId = $appid;        $this->appSecret = $appsecret;        $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=".$this->appId."&secret=".$this->appSecret;        $res = $this->https_request($url);        $result = json_decode($res, true);        $this->access_token = $result["access_token"];//令牌//        $this->lasttime = 1395049256;//        $this->access_token = "nRZvVpDU7LxcSi7GnG2LrUcmKbAECzRf0NyDBwKlng4nMPf88d34pkzdNcvhqm4clidLGAS18cN1RTSK60p49zIZY4aO13sF-eqsCs0xjlbad-lKVskk8T7gALQ5dIrgXbQQ_TAesSasjJ210vIqTQ";//        if (time() > ($this->lasttime + 7200)){//            $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=".$this->appid."&secret=".$this->appsecret;//            $res = $this->https_request($url);//            $result = json_decode($res, true);//            $this->access_token = $result["access_token"];//            $this->lasttime = time();//        }    }//***************************获取基本参数 开始*************************************//获取用户基本信息    public function get_user_info($openid)    {        $url = "https://api.weixin.qq.com/cgi-bin/user/info?access_token=".$this->access_token."&openid=".$openid."&lang=zh_CN";        $res = $this->https_request($url);        return json_decode($res, true);    }//https请求(获取access_token等信息,可多次调用获取其他信息)    public function https_request($url, $data = null)    {        $curl = curl_init();        curl_setopt($curl, CURLOPT_URL, $url);        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, FALSE);        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, FALSE);        if (!empty($data)){            curl_setopt($curl, CURLOPT_POST, 1);            curl_setopt($curl, CURLOPT_POSTFIELDS, $data);        }        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);        $output = curl_exec($curl);        curl_close($curl);        return $output;    }//***************************获取基本参数 结束*************************************    //获取$openid    public function get_appid($appid, $appsecret)    {        if (!$code = I('get.code')) {            $redirect_uri = urlencode('http://'.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF'].'?'.$_SERVER['QUERY_STRING']);            $get_code_uri = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=$appid&redirect_uri=$redirect_uri&response_type=code&scope=snsapi_base&state=STATE&connect_redirect=1#wechat_redirect";            header("location: $get_code_uri");  die;        } else {            $get_access_token_uri = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=$appid&secret=$appsecret&code=$code&grant_type=authorization_code";            //初始化curl            $ch = curl_init();            //设置超时            curl_setopt($ch, CURLOPT_TIMEOUT, 20);            curl_setopt($ch, CURLOPT_URL, $get_access_token_uri);            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER,FALSE);            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST,FALSE);            curl_setopt($ch, CURLOPT_HEADER, FALSE);            curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);            //运行curl，结果以jason形式返回            $res = curl_exec($ch);            curl_close($ch);            //取出openid            $data = json_decode($res,true);            $openid = $data['openid'];            return $openid;        }    }//***************************微信消息推送*******开始****************************************//    /*     * 推送     * $touser：$openid     * $template_id：模板消息的id     * $url:要跳转的地址     * $token：用户授权     * $data：要推送的消息     */    public function doSend($touser, $template_id, $url='', $token, $data,$topcolor = '#7B68EE')    {        $template = array(            'touser' => $touser,            'template_id' => $template_id,            'url' => $url,            'topcolor' => $topcolor,            'data' => $data        );        $json_template = json_encode($template);        $url = "https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=" . $token;        $dataRes = $this->request_post($url, urldecode($json_template));        $dataRes=json_decode($dataRes,true);        if ($dataRes['errcode'] == 0) {            return true;        } else {            return $dataRes;        }    }    public function request_post($url = '', $param = '')    {        if (empty($url) || empty($param)) {            return false;        }        $postUrl = $url;        $curlPost = $param;        $ch = curl_init(); //初始化curl        curl_setopt($ch, CURLOPT_URL, $postUrl); //抓取指定网页        curl_setopt($ch, CURLOPT_HEADER, 0); //设置header        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); //要求结果为字符串且输出到屏幕上        curl_setopt($ch, CURLOPT_POST, 1); //post提交方式        curl_setopt($ch, CURLOPT_POSTFIELDS, $curlPost);        $data = curl_exec($ch); //运行curl        curl_close($ch);        return $data;    }    //用户授权博要参数：获取用户基本信息（关注了公众号） protected    public function getToken($appid, $appsecret)    {        $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=" . $appid . "&secret=" . $appsecret;        $token = $this->request_get($url);        $token = json_decode(stripslashes($token));        $arr = json_decode(json_encode($token), true);        $access_token = $arr['access_token'];        return $access_token;    }    public   function request_get($url = '')    {        if (empty($url)) {            return false;        }        $ch = curl_init();        curl_setopt($ch, CURLOPT_URL, $url);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);        $data = curl_exec($ch);        curl_close($ch);        return $data;    }    //***************************微信消息推送***结束********************************************//    //***************************微信jssdk 开始********************************************//    public function getSignPackage() {        $jsapiTicket = $this->getJsApiTicket();        // 注意 URL 一定要动态获取，不能 hardcode.        $protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";        $url = "$protocol$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";        $timestamp = time();        $nonceStr = $this->createNonceStr();        // 这里参数的顺序要按照 key 值 ASCII 码升序排序        $string = "jsapi_ticket=$jsapiTicket&noncestr=$nonceStr&timestamp=$timestamp&url=$url";        $signature = sha1($string);        $signPackage = array(            "appId"     => $this->appId,            "nonceStr"  => $nonceStr,            "timestamp" => $timestamp,            "url"       => $url,            "signature" => $signature,            "rawString" => $string        );        return $signPackage;    }    private function createNonceStr($length = 16) {        $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";        $str = "";        for ($i = 0; $i < $length; $i++) {            $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);        }        return $str;    }    private function getJsApiTicket() {        // jsapi_ticket 应该全局存储与更新，以下代码以写入到文件中做示例        $data = json_decode($this->get_php_file("jsapi_ticket.php"));        if ($data->expire_time < time()) {            $accessToken = $this->getAccessToken();            // 如果是企业号用以下 URL 获取 ticket            // $url = "https://qyapi.weixin.qq.com/cgi-bin/get_jsapi_ticket?access_token=$accessToken";            $url = file_get_contents("https://api.weixin.qq.com/cgi-bin/ticket/getticket?type=jsapi&access_token=$accessToken");            $res = json_decode($url,true);            $ticket=$res['ticket'];            if ($ticket) {                $data->expire_time = time() + 7000;                $data->jsapi_ticket = $ticket;                $this->set_php_file("jsapi_ticket.php", json_encode($data));            }        } else {            $ticket = $data->jsapi_ticket;        }        return $ticket;    }    //同getToken()    private function getAccessToken() {        // access_token 应该全局存储与更新，以下代码以写入到文件中做示例        $data = json_decode($this->get_php_file("access_token.php"));        if ($data->expire_time < time()) {            // 如果是企业号用以下URL获取access_token            // $url = "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=$this->appId&corpsecret=$this->appSecret";            $url = file_get_contents("https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=$this->appId&secret=$this->appSecret");            $res = json_decode($url,true);            $access_token=$res['access_token'];            if ($access_token) {                $data->expire_time = time() + 7000;                $data->access_token = $access_token;                $this->set_php_file("access_token.php", json_encode($data));            }        } else {            $access_token = $data->access_token;        }        return $access_token;    }    private function httpGet($url) {        $curl = curl_init();        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);        curl_setopt($curl, CURLOPT_TIMEOUT, 500);        // 为保证第三方服务器与微信服务器之间数据传输的安全性，所有微信接口采用https方式调用，必须使用下面2行代码打开ssl安全校验。        // 如果在部署过程中代码在此处验证失败，请到 http://curl.haxx.se/ca/cacert.pem 下载新的证书判别文件。        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, true);        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, true);        curl_setopt($curl, CURLOPT_URL, $url);        $res = curl_exec($curl);        curl_close($curl);        return $res;    }    private function get_php_file($filename) {        return trim(substr(file_get_contents($filename), 15));    }    private function set_php_file($filename, $content) {        $fp = fopen($filename, "w");        fwrite($fp, "<?php exit();?>" . $content);        fclose($fp);    }//***************************微信jssdk 结束********************************************//}?>